<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>African Emerging Scholars Research Network (AESRN) | Member Portal</title>
    <link rel="icon" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png" type="image/png">
    <link itemprop="image" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">
    <meta property="og:logo" content="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">
    <meta name="twitter:logo" content="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">

    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/site.webmanifest">
    <script async src="https://tally.so/widgets/embed.js"></script>
    <style type="text/css">
      /* ---------- RESET & BASE ---------- */
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      html, body { 
        height: 100%; 
        width: 100%;
        overflow-x: hidden;
      }
      
      body { 
        display: flex; 
        flex-direction: column; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        color: #1e1e1e;
        -webkit-font-smoothing: antialiased;
      }
      
      /* ---------- LOGIN CONTAINER - BLUE GRADIENT ---------- */
      .login-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px;
        background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        width: 100%;
        min-height: 100vh;
      }
      
      .login-box {
        background: white;
        border-radius: 8px;
        padding: 40px 32px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      }
      .login-header { text-align: center; margin-bottom: 32px; }
      .login-logo-circle { width: 100px; height: 100px; margin: 0 auto 20px auto; display: flex; align-items: center; justify-content: center; }
      .logo-circle-image { width: 100%; height: 100%; object-fit: contain; }
      .login-title { font-size: 24px; font-weight: 600; color: #000; margin-bottom: 8px; }
      .login-subtitle { color: #5e5e5e; font-size: 14px; }
      .form-group { margin-bottom: 20px; }
      .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
      .form-input { width: 100%; padding: 12px 14px; border: 1px solid #d1d1d1; border-radius: 4px; font-size: 15px; }
      .form-input:focus { outline: none; border-color: #1a237e; }
      .login-button { width: 100%; padding: 14px 18px; background: #1a237e; color: white; border: none; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 12px; }
      .login-button:hover { background: #0f1555; }
      .copyright-full { text-align: center; margin-top: 32px; font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 20px; }
      .error-message, .attempts-warning { color: #d32f2f; font-size: 13px; margin-top: 16px; text-align: center; display: none; padding: 12px; background: #ffebee; border-radius: 4px; }
      .attempts-warning { color: #b85a00; background: #fff1e0; }
      
      /* ---------- DASHBOARD ‚Äì THREE OPTIONS + WHITE SESSION CARD ---------- */
      .dashboard-container {
        flex: 1;
        display: none;
        flex-direction: column;
        background: #f5f7fc;
        width: 100%;
        min-height: 100vh;
        padding: 30px 20px;
      }
      
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 16px 30px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        margin-bottom: 40px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .dashboard-welcome { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 500; color: #1a237e; }
      .dashboard-welcome span { background: #1a237e; color: white; padding: 6px 14px; border-radius: 30px; font-size: 15px; font-weight: 600; }
      .dashboard-logout { background: #e74c3c; color: white; border: none; border-radius: 30px; padding: 10px 24px; font-weight: 600; cursor: pointer; font-size: 14px; }
      .dashboard-logout:hover { background: #c0392b; }
      
      .action-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
        align-items: center;
        max-width: 1100px;
        margin: 20px auto;
        width: 100%;
      }
      .action-card {
        background: white;
        border-radius: 24px;
        padding: 40px 30px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.05);
        flex: 1 1 280px;
        max-width: 360px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: all 0.25s ease;
        border: 1px solid rgba(26,35,126,0.08);
        cursor: pointer;
      }
      .action-card:hover { transform: translateY(-6px); box-shadow: 0 25px 45px rgba(26,35,126,0.12); border-color: rgba(26,35,126,0.2); }
      .action-icon { font-size: 52px; margin-bottom: 20px; background: #edf0fa; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: #1a237e; }
      .action-title { font-size: 26px; font-weight: 700; color: #1a237e; margin-bottom: 12px; letter-spacing: -0.5px; }
      .action-desc { color: #5a5a6e; font-size: 16px; line-height: 1.5; margin-bottom: 10px; }
      .action-badge { margin-top: 15px; background: #e8eaf6; color: #1a237e; padding: 8px 18px; border-radius: 40px; font-size: 14px; font-weight: 600; }
      
      /* Session info card ‚Äì white, centered */
      .session-info-card {
        background: white;
        border-radius: 60px;
        padding: 18px 30px;
        margin: 50px auto 20px auto;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.02);
        border: 1px solid rgba(0,0,0,0.04);
        max-width: 750px;
        width: 100%;
        color: #1e1e1e;
        font-size: 15px;
      }
      .session-info-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fafcff;
        padding: 5px 16px;
        border-radius: 40px;
        color: #2c3e50;
      }
      .session-info-strong { color: #1a237e; font-weight: 700; margin-left: 4px; }
      .ghana-time-dash {
        font-family: monospace;
        font-weight: 700;
        color: #1a237e;
        background: #edf0fa;
        padding: 5px 12px;
        border-radius: 40px;
      }
      .copyright-white {
        color: #5e5e5e;
        font-size: 13px;
        font-weight: 400;
        letter-spacing: 0.2px;
      }
      
      /* ---------- FORM CONTAINER ‚Äì ALWAYS ACTIVE, NEVER UNLOADED ---------- */
      .form-container {
        flex: 1;
        position: relative;
        display: none;
        width: 100%;
        min-height: 100vh;
        background: white;
      }
      iframe { 
        position: absolute; 
        top: 0; 
        right: 0; 
        bottom: 0; 
        left: 0; 
        border: 0; 
        background: white;  
      }
      
      /* Back button ‚Äì form view */
      .back-to-dashboard {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 2000;
        background: white;
        color: #1a237e;
        border: 1px solid #1a237e;
        padding: 12px 26px;
        border-radius: 40px;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        transition: all 0.2s;
      }
      .back-to-dashboard:hover { background: #1a237e; color: white; }
      
      /* ---------- LOADING OVERLAY ‚Äì FAST CONFIG ---------- */
      .loading-overlay {
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0;
        background: rgba(255,255,255,0.95); 
        display: flex; 
        flex-direction: column;
        justify-content: center; 
        align-items: center; 
        z-index: 100;
      }
      .loading-spinner {
        width: 50px; 
        height: 50px; 
        border: 4px solid #f3f3f3; 
        border-top: 4px solid #1a237e;
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
        margin-bottom: 20px;
      }
      .loading-text {
        font-size: 16px;
        color: #1a237e;
        font-weight: 500;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* ---------- GLOBAL LOADER (ensures everything loads before dashboard) ---------- */
      .app-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
      }
      .app-loader-logo {
        width: 120px;
        height: 120px;
        margin-bottom: 30px;
        animation: pulse 1.5s infinite;
      }
      .app-loader-text {
        color: white;
        font-size: 20px;
        font-weight: 500;
        letter-spacing: 2px;
      }
      @keyframes pulse { 0% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; transform: scale(1); } }
      
      /* ---------- NOTIFICATIONS & MODALS ---------- */
      .login-greeting-notification { 
        position: fixed; top: 20px; right: 20px; background: #1a237e; color: white; 
        padding: 20px 30px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        z-index: 2000; display: none; align-items: center; gap: 15px; 
        animation: slideInRight 0.5s ease; max-width: 350px; 
      }
      .logout-notification { 
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        background: #2c3e50; color: white; padding: 30px 40px; border-radius: 12px; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 3000; display: none; 
        flex-direction: column; align-items: center; gap: 20px; min-width: 300px; 
        text-align: center; 
      }
      
      /* ========== MINIMAL / MODERN INACTIVITY WARNING ========== */
      .inactivity-warning {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        color: #1a1e3a;
        border-radius: 28px;
        padding: 40px 36px;
        width: 90%;
        max-width: 420px;
        z-index: 4000;
        text-align: center;
        box-shadow: 0 30px 50px rgba(0,0,0,0.2);
        border: 1px solid rgba(0,0,0,0.04);
        backdrop-filter: blur(4px);
        animation: fadeScale 0.25s ease-out;
      }
      @keyframes fadeScale {
        from { opacity: 0.8; transform: translate(-50%, -50%) scale(0.96); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      }
      .inactivity-warning h3 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 16px;
        letter-spacing: -0.3px;
        color: #1a237e;
      }
      .inactivity-timer {
        font-size: 48px;
        font-weight: 700;
        font-family: 'Courier New', monospace;
        background: #f2f4fc;
        display: inline-block;
        padding: 16px 28px;
        border-radius: 60px;
        margin: 20px 0 18px;
        color: #1a237e;
        border: 1px solid #dde2f0;
      }
      .inactivity-message {
        font-size: 17px;
        color: #4a4a6a;
        margin-bottom: 28px;
        line-height: 1.5;
      }
      .keep-active-button {
        background: #1a237e;
        color: white;
        border: none;
        border-radius: 60px;
        padding: 16px 32px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.2s;
        border: 1px solid #1a237e;
      }
      .keep-active-button:hover {
        background: #0f1555;
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(26,35,126,0.2);
      }
      
      /* ========== MINIMAL LOGOUT CONFIRMATION ========== */
      .confirmation-overlay { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        background: rgba(30, 30, 40, 0.5);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        z-index: 5000; 
        justify-content: center; 
        align-items: center; 
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      
      .confirmation-dialog { 
        background: white; 
        border-radius: 32px; 
        padding: 44px 40px; 
        width: 90%; 
        max-width: 420px; 
        text-align: center; 
        box-shadow: 0 30px 50px rgba(0,0,0,0.15);
        animation: scaleUp 0.25s ease;
        border: 1px solid rgba(255,255,255,0.3);
      }
      @keyframes scaleUp { 
        from { opacity: 0.8; transform: scale(0.96); } 
        to { opacity: 1; transform: scale(1); } 
      }
      
      .confirmation-icon {
        font-size: 44px;
        margin-bottom: 24px;
        background: #f8f9fc;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-left: auto;
        margin-right: auto;
        color: #1a1e3a;
        border: 1px solid #eef2f7;
      }
      
      .confirmation-title { 
        font-size: 30px; 
        font-weight: 600; 
        color: #1a1e3a; 
        margin-bottom: 12px;
        letter-spacing: -0.4px;
      }
      
      .confirmation-message { 
        color: #5a5a7a; 
        font-size: 18px; 
        margin-bottom: 36px;
        line-height: 1.5;
        font-weight: 420;
      }
      
      .confirmation-buttons { 
        display: flex; 
        gap: 16px; 
        justify-content: center; 
        width: 100%;
      }
      
      .confirm-button {
        flex: 1;
        padding: 16px 20px;
        border: none;
        border-radius: 60px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: white;
        border: 1.5px solid #d0d6e8;
        color: #2c3e50;
      }
      .confirm-button:hover {
        background: #f2f5ff;
        border-color: #1a237e;
      }
      
      .confirm-yes {
        background: #1a237e;
        border: 1.5px solid #1a237e;
        color: white;
      }
      .confirm-yes:hover {
        background: #0f1555;
        border-color: #0f1555;
      }
      
      @media (max-width: 768px) {
        .dashboard-header { flex-direction: column; align-items: flex-start; }
        .session-info-card { flex-direction: column; align-items: center; border-radius: 30px; padding: 20px; gap: 15px; }
        .confirmation-dialog { padding: 36px 28px; }
        .confirmation-title { font-size: 28px; }
        .inactivity-timer { font-size: 40px; }
      }
    </style>
  </head>
  <body>
    <!-- GLOBAL APP LOADER ‚Äì ensures everything loads before dashboard appears -->
    <div class="app-loader" id="appLoader">
      <img src="https://raw.githubusercontent.com/aesrn30/aesrn/main/Lablogo.png" alt="AESRN Logo" class="app-loader-logo">
      <div class="app-loader-text">Loading Portal...</div>
    </div>

    <!-- LOGIN CONTAINER -->
    <div class="login-container" id="loginContainer" style="display: none;">
      <div class="login-box">
        <div class="login-header">
          <div class="login-logo-circle">
            <img src="https://raw.githubusercontent.com/aesrn30/aesrn/main/Lablogo.png" alt="AESRN Logo" class="logo-circle-image">
          </div>
          <div class="login-title">Member Access Portal</div>
          <div class="login-subtitle">Enter your credentials to access member services.</div>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input type="email" id="email" class="form-input" placeholder="Enter registered email address" required autocomplete="off">
          </div>
          <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <input type="password" id="password" class="form-input" placeholder="Enter access password" required autocomplete="off">
          </div>
          <button type="submit" class="login-button" id="loginButton">Log In</button>
          <div class="copyright-full" id="copyrightFull">Copyright ¬© <span id="dynamicYear"></span> AESRN. All rights reserved.</div>
          <div class="error-message" id="errorMessage">Invalid email or password.</div>
          <div class="attempts-warning" id="attemptsWarning">Multiple failed attempts may temporarily restrict access.</div>
        </form>
      </div>
    </div>
    
    <!-- DASHBOARD ‚Äì THREE action cards: 1) View Assignment, 2) Make a Submission, 3) Review Materials -->
    <div class="dashboard-container" id="dashboardContainer">
      <div class="dashboard-header">
        <div class="dashboard-welcome">
          <span id="dashboardUserName"></span> ¬∑ Member Dashboard
        </div>
        <button class="dashboard-logout" id="dashboardLogoutBtn">Log out</button>
      </div>
      
      <div class="action-grid">
        <!-- CARD 1: View Assignment (renamed, "kinda" removed) -->
        <div class="action-card" id="viewAssignmentCard">
          <div class="action-icon">üìã</div>
          <div class="action-title">View Assignment</div>
          <div class="action-desc">Check your assigned tasks & materials.</div>
        </div>
        <!-- CARD 2: Make a Submission -->
        <div class="action-card" id="makeSubmissionCard">
          <div class="action-icon">üìÑ</div>
          <div class="action-title">Make a Submission</div>
          <div class="action-desc">Drop your assigned section here.</div>
        </div>
        <!-- CARD 3: Review Materials -->
        <div class="action-card" id="reviewMaterialsCard">
          <div class="action-icon">üìö</div>
          <div class="action-title">Review Materials</div>
          <div class="action-desc">Catch up on everything, section by section.</div>
        </div>
      </div>
      
      <!-- SESSION INFO CARD ‚Äì white, centered. "Logged in as" and "Logout" items COMPLETELY REMOVED from footer. -->
      <div class="session-info-card" id="sessionInfoCard">
        <!-- üë§ Logged in as: and üö™ Logout items have been removed entirely. -->
        <!-- Only the following three items remain: email, Ghana time, copyright -->
        <div class="session-info-item">
          üìß <a href="mailto:research.aesrn@yahoo.com" style="color: #1a237e; text-decoration: none; font-weight: 500;">research.aesrn@yahoo.com</a>
        </div>
        <div class="session-info-item">
          üá¨üá≠ <span class="ghana-time-dash" id="ghanaTimeDashboard">11:30:57</span> GMT
        </div>
        <div class="session-info-item copyright-white">
          ¬© <span id="infoCardYear">2026</span> AESRN. All rights reserved.
        </div>
      </div>
    </div>
    
    <!-- FORM CONTAINER ‚Äì PRELOADED, KEPT ALIVE, NEVER UNLOADED -->
    <div class="form-container" id="formContainer">
      <!-- LOADING OVERLAY ‚Äì shown only briefly on first open, then hidden forever -->
      <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Opening submission form...</div>
      </div>
      
      <button class="back-to-dashboard" id="backToDashboardBtn">
        ‚Üê  Dashboard
      </button>
      
      <!-- iframe PRELOADED and PERSISTENT: src is set ONCE and never cleared -->
      <iframe 
        src="https://tally.so/r/dWd6gA?transparentBackground=1&formEventsForwarding=1" 
        width="100%" 
        height="100%" 
        frameborder="0" 
        marginheight="0" 
        marginwidth="0" 
        title="AESRN Submission Form (persistent)"
        id="formIframe"
        style="visibility: hidden; background: white;"
        onload="handleIframeLoad()"
      ></iframe>
    </div>
    
    <!-- NOTIFICATIONS / MODALS -->
    <div class="login-greeting-notification" id="loginGreeting">
      <div class="greeting-icon" id="greetingIcon">üëã</div>
      <div class="greeting-content"><h4 id="greetingText">Welcome</h4><p id="userGreeting"></p></div>
    </div>
    <div class="logout-notification" id="logoutNotification">
      <div class="logout-spinner"></div>
      <div class="logout-message">Logged out successfully!</div>
      <div class="logout-countdown">Redirecting in <span id="logoutCountdown">5</span> seconds...</div>
    </div>
    
    <!-- MINIMAL INACTIVITY WARNING (timer from 1:50) -->
    <div class="inactivity-warning" id="inactivityWarning">
      <h3>Session timeout</h3>
      <div class="inactivity-timer" id="inactivityTimer">1:50</div>
      <p class="inactivity-message">You've been inactive. Stay logged in?</p>
      <button class="keep-active-button" id="keepActiveButton">Continue session</button>
    </div>
    
    <!-- MINIMAL LOGOUT CONFIRMATION DIALOG -->
    <div class="confirmation-overlay" id="confirmationDialog">
      <div class="confirmation-dialog">
        <div class="confirmation-icon">üö™</div>
        <div class="confirmation-title">Log out</div>
        <div class="confirmation-message">End your session?</div>
        <div class="confirmation-buttons">
          <button class="confirm-button confirm-yes" id="confirmLogout">Yes, logout</button>
          <button class="confirm-button confirm-no" id="cancelLogout">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      // ---------- AUTO COPYRIGHT ----------
      function updateAllCopyrightYears() {
        const currentYear = new Date().getFullYear();
        document.getElementById('dynamicYear') && (document.getElementById('dynamicYear').textContent = currentYear);
        document.getElementById('infoCardYear') && (document.getElementById('infoCardYear').textContent = currentYear);
      }

      // ---------- USER CREDENTIALS ----------
      const userMap = {
        "malikseidu4@gmail.com": "Abdul-Malik", "Malikseidu4@gmail.com": "Abdul-Malik",
        "abdul0247080685@gmail.com": "Abdul Latif", "Abdul0247080685@gmail.com": "Abdul Latif",
        "ednadie93@gmail.com": "Edna", "Ednadie93@gmail.com": "Edna",
        "issahaqalhassan26@gmail.com": "Alhassan", "Issahaqalhassan26@gmail.com": "Alhassan",
        "mudassiribrahim30@gmail.com": "Mudasir", "Mudassiribrahim30@gmail.com": "Mudasir"
      };
      const correctPassword = "Scholar123";
      
      // ---------- GLOBALS ----------
      let failedAttempts = 0;
      const maxAttempts = 5;
      let currentUserName = "", currentUserEmail = "";
      let ghanaTimeInterval;
      
      // session timings: total 2min, warning at 1:50 (i.e., after 10 seconds)
      const SESSION_TIMEOUT = 2 * 60 * 1000;        // 2 minutes
      const WARNING_TIME = 10 * 1000;               // show warning after 10s (so timer starts at 1:50)
      let inactivityTimer, warningTimer;
      let countdownInterval = null;
      
      const ACTIVE_SESSIONS_KEY = 'aesrn_active_sessions';
      const CURRENT_SESSION_KEY = 'aesrn_current_session';
      const USER_SESSION_KEY = 'aesrn_user_session';
      const SHOWN_GREETING_KEY = 'aesrn_shown_greeting';
      
      // Flag to track if iframe has ever been fully loaded ‚Äì we keep it alive
      let iframeEverLoaded = false;
      
      // ---------- SESSION FUNCTIONS ----------
      function generateSessionId() { return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); }
      function getCurrentSessionId() { return sessionStorage.getItem(CURRENT_SESSION_KEY); }
      function setCurrentSessionId(sessionId) { sessionStorage.setItem(CURRENT_SESSION_KEY, sessionId); }
      function getActiveSessions() { const s = localStorage.getItem(ACTIVE_SESSIONS_KEY); return s ? JSON.parse(s) : {}; }
      function saveActiveSessions(sessions) { localStorage.setItem(ACTIVE_SESSIONS_KEY, JSON.stringify(sessions)); }
      function hasGreetingBeenShown(sessionId) { const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}'); return g[sessionId] || false; }
      function markGreetingAsShown(sessionId) { const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}'); g[sessionId] = true; localStorage.setItem(SHOWN_GREETING_KEY, JSON.stringify(g)); }
      function clearGreetingStatus(sessionId) { const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}'); delete g[sessionId]; localStorage.setItem(SHOWN_GREETING_KEY, JSON.stringify(g)); }
      
      function isUserAlreadyLoggedIn(email) {
        const sessions = getActiveSessions();
        const userSession = sessions[email];
        if (!userSession) return false;
        if (Date.now() > userSession.expiry) { delete sessions[email]; saveActiveSessions(sessions); return false; }
        const currentSessionId = getCurrentSessionId();
        return !(userSession.sessionId === currentSessionId);
      }
      
      function registerUserSession(email, name) {
        const sessionId = generateSessionId();
        const sessions = getActiveSessions();
        if (sessions[email]) { clearGreetingStatus(sessions[email].sessionId); delete sessions[email]; }
        sessions[email] = { sessionId, expiry: Date.now() + SESSION_TIMEOUT, name, loginTime: Date.now(), isFirstLogin: true };
        saveActiveSessions(sessions);
        setCurrentSessionId(sessionId);
        const userSession = { email, name, sessionId, loginTime: Date.now(), expiry: Date.now() + SESSION_TIMEOUT, isFirstLogin: true };
        localStorage.setItem(USER_SESSION_KEY, JSON.stringify(userSession));
        return sessionId;
      }
      
      function removeUserSession(email) {
        const sessions = getActiveSessions();
        if (sessions[email]) { clearGreetingStatus(sessions[email].sessionId); delete sessions[email]; saveActiveSessions(sessions); }
        localStorage.removeItem(USER_SESSION_KEY);
        sessionStorage.removeItem(CURRENT_SESSION_KEY);
      }
      
      // ---------- TIME ----------
      function getGhanaTime() { 
        const g = new Date(new Date().toLocaleString('en-US', { timeZone: 'Africa/Accra' }));
        return `${g.getHours().toString().padStart(2,'0')}:${g.getMinutes().toString().padStart(2,'0')}:${g.getSeconds().toString().padStart(2,'0')}`;
      }
      function updateGhanaTimeDisplay() { 
        const t = getGhanaTime();
        const dash = document.getElementById('ghanaTimeDashboard');
        if (dash) dash.textContent = t;
      }
      function startGhanaTimeUpdates() { updateGhanaTimeDisplay(); ghanaTimeInterval = setInterval(updateGhanaTimeDisplay, 1000); }
      function stopGhanaTimeUpdates() { clearInterval(ghanaTimeInterval); }
      
      // ---------- LOGIN VALIDATION ----------
      function validateLogin(email, password) {
        const normEmail = email.trim(), normPass = password.trim();
        const key = Object.keys(userMap).find(k => k.toLowerCase() === normEmail.toLowerCase());
        if (key) { currentUserName = userMap[key]; currentUserEmail = key; return normPass === correctPassword; }
        return false;
      }
      
      function handleFailedLogin() {
        failedAttempts++;
        const err = document.getElementById('errorMessage'), warn = document.getElementById('attemptsWarning');
        const email = document.getElementById('email'), pwd = document.getElementById('password'), btn = document.getElementById('loginButton');
        err.style.display = 'block'; email.classList.add('error'); pwd.classList.add('error'); pwd.value = ''; email.focus();
        if (failedAttempts >= 3) warn.style.display = 'block';
        if (failedAttempts >= maxAttempts) {
          btn.disabled = true; btn.textContent = 'Access Temporarily Restricted';
          setTimeout(() => { btn.disabled = false; btn.textContent = 'Log In'; warn.style.display = 'none'; failedAttempts = 0; }, 30000);
        }
        setTimeout(() => { email.classList.remove('error'); pwd.classList.remove('error'); }, 2000);
      }
      
      // ---------- DASHBOARD ‚Äì ONLY SHOW AFTER EVERYTHING IS READY ----------
      function showDashboard() {
        // Update all UI elements
        document.getElementById('dashboardUserName').textContent = currentUserName;
        
        // Hide login, show dashboard
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('dashboardContainer').style.display = 'flex';
        // Form container stays hidden until user clicks "Make Submission"
        document.getElementById('formContainer').style.display = 'none';
        
        startGhanaTimeUpdates();
        const sessionId = registerUserSession(currentUserEmail, currentUserName);
        showLoginGreeting();
        resetActivityTimers();
        attachActivityListeners();
      }
      
      // ---------- IFRAME HANDLING ‚Äì PERSISTENT, NEVER CLEARED ----------
      function handleIframeLoad() {
        iframeEverLoaded = true;
        // If form container is visible, hide loading overlay immediately
        if (document.getElementById('formContainer').style.display === 'flex') {
          hideLoading();
        } else {
          // Background preload: ensure loading overlay stays hidden
          document.getElementById('loadingOverlay').style.display = 'none';
        }
        // Ensure iframe stays visible when form is active, but we control via visibility
      }
      
      function hideLoading() { 
        const lo = document.getElementById('loadingOverlay');
        if (lo) { 
          lo.style.opacity = '0'; 
          setTimeout(() => { 
            lo.style.display = 'none'; 
          }, 300); 
        }
        const ifr = document.getElementById('formIframe');
        if (ifr) ifr.style.visibility = 'visible';
      }
      
      function showLoading() { 
        const lo = document.getElementById('loadingOverlay');
        if (lo) { 
          lo.style.display = 'flex'; 
          lo.style.opacity = '1'; 
        }
      }
      
      // Open submission: INSTANTANEOUS on subsequent opens because iframe is always alive
      function openSubmissionForm() {
        document.getElementById('dashboardContainer').style.display = 'none';
        document.getElementById('formContainer').style.display = 'flex';
        
        const ifr = document.getElementById('formIframe');
        if (ifr) {
          // If iframe already loaded before, show it instantly with no loader
          if (iframeEverLoaded) {
            ifr.style.visibility = 'visible';
            // Ensure loading overlay is hidden
            document.getElementById('loadingOverlay').style.display = 'none';
          } else {
            // First time: show loading overlay
            ifr.style.visibility = 'hidden';
            showLoading();
            // If iframe somehow already complete, hide loading after tiny delay
            if (ifr.contentDocument && ifr.contentDocument.readyState === 'complete') {
              setTimeout(hideLoading, 50);
            }
          }
        }
      }
      
      // Review materials
      function openReviewMaterials() {
        window.open('https://swpgh-my.sharepoint.com/:f:/g/personal/mohammed_mudasir_tth_gov_gh/IgDopS4nZaKiS4WhTxSeRb6FAbaOLyIXT4b1TMfT6GT26nM?e=G6Fqam', '_blank');
      }
      
      // View Assignment 
      function openViewAssignment() {
        window.open('https://swpgh-my.sharepoint.com/:f:/g/personal/mohammed_mudasir_tth_gov_gh/IgAIsMG6e8n2QouivuzCfkg8Ac6Tv18kYWZP7inlnNq07hI?e=gGnKAF', '_blank');
      }
      
      // Back to dashboard ‚Äì iframe stays loaded, just hidden from view
      function backToDashboard() {
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('dashboardContainer').style.display = 'flex';
        // Do NOT clear iframe src or unload ‚Äì just hide it visually
        const ifr = document.getElementById('formIframe');
        if (ifr) ifr.style.visibility = 'hidden';
        // Loading overlay stays hidden for next time
        document.getElementById('loadingOverlay').style.display = 'none';
      }
      
      // ---------- ACTIVITY TIMERS (modified to count down from 1:50) ----------
      function resetActivityTimers() {
        clearTimeout(inactivityTimer); 
        clearTimeout(warningTimer); 
        if (countdownInterval) clearInterval(countdownInterval);
        hideInactivityWarning();
        updateSessionExpiry();
        // warning after 10 seconds -> timer shows 1:50
        warningTimer = setTimeout(showInactivityWarning, WARNING_TIME);
        inactivityTimer = setTimeout(logoutDueToInactivity, SESSION_TIMEOUT);
      }
      
      function showInactivityWarning() {
        document.getElementById('inactivityWarning').style.display = 'block';
        startInactivityCountdown(110); // 110 seconds = 1:50
      }
      
      function hideInactivityWarning() { 
        document.getElementById('inactivityWarning').style.display = 'none';
        if (countdownInterval) clearInterval(countdownInterval);
      }
      
      function startInactivityCountdown(seconds) {
        const timerEl = document.getElementById('inactivityTimer');
        if (countdownInterval) clearInterval(countdownInterval);
        
        function updateDisplay() {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          timerEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
          if (seconds <= 0) {
            clearInterval(countdownInterval);
            logoutDueToInactivity();
          }
        }
        updateDisplay();
        countdownInterval = setInterval(() => {
          seconds--;
          updateDisplay();
        }, 1000);
      }
      
      function logoutDueToInactivity() { 
        if (countdownInterval) clearInterval(countdownInterval);
        showCustomAlert('Session Expired', 'Session expired due to inactivity.', 'info'); 
        logout(); 
      }
      
      function updateSessionExpiry() {
        if (currentUserEmail) {
          const sessions = getActiveSessions();
          if (sessions[currentUserEmail]) { sessions[currentUserEmail].expiry = Date.now() + SESSION_TIMEOUT; saveActiveSessions(sessions); }
          const userSession = JSON.parse(localStorage.getItem(USER_SESSION_KEY) || '{}');
          if (userSession.email) { userSession.expiry = Date.now() + SESSION_TIMEOUT; localStorage.setItem(USER_SESSION_KEY, JSON.stringify(userSession)); }
        }
      }
      
      function showCustomAlert(title, message, type) {
        const icon = type==='info' ? '‚ÑπÔ∏è' : '‚ö†Ô∏è';
        const overlay = document.getElementById('confirmationDialog');
        overlay.innerHTML = `<div class="confirmation-dialog"><div class="confirmation-icon">${icon}</div><div class="confirmation-title">${title}</div><div class="confirmation-message">${message}</div><div class="confirmation-buttons"><button class="confirm-button confirm-no" id="closeAlert">OK</button></div></div>`;
        overlay.style.display = 'flex';
        document.getElementById('closeAlert').addEventListener('click', function() { overlay.style.display = 'none'; });
      }
      
      function trackUserActivity() { resetActivityTimers(); }
      function attachActivityListeners() {
        document.addEventListener('mousemove', trackUserActivity); document.addEventListener('keydown', trackUserActivity);
        document.addEventListener('click', trackUserActivity); document.addEventListener('scroll', trackUserActivity);
      }
      function detachActivityListeners() {
        document.removeEventListener('mousemove', trackUserActivity); document.removeEventListener('keydown', trackUserActivity);
        document.removeEventListener('click', trackUserActivity); document.removeEventListener('scroll', trackUserActivity);
      }
      
      // ---------- GREETING ----------
      function getGreeting() { const h = new Date().getHours(); if (h<12) return "Good Morning"; if (h<17) return "Good Afternoon"; return "Good Evening"; }
      function getGreetingIcon() { const h = new Date().getHours(); if (h<12) return "üåÖ"; if (h<17) return "‚òÄÔ∏è"; return "üåô"; }
      function showLoginGreeting() {
        const sessionId = getCurrentSessionId();
        if (hasGreetingBeenShown(sessionId)) return;
        document.getElementById('greetingText').textContent = getGreeting();
        document.getElementById('greetingIcon').textContent = getGreetingIcon();
        document.getElementById('userGreeting').textContent = `${getGreeting()}, ${currentUserName}!`;
        document.getElementById('loginGreeting').style.display = 'flex';
        markGreetingAsShown(sessionId);
        setTimeout(() => { 
          document.getElementById('loginGreeting').style.animation = 'fadeOutUp 0.5s ease';
          setTimeout(() => { 
            document.getElementById('loginGreeting').style.display = 'none'; 
            document.getElementById('loginGreeting').style.animation = 'slideInRight 0.5s ease'; 
          }, 500);
        }, 5000);
      }
      
      // ---------- LOGOUT ‚Äì preserve iframe, do not unload ----------
      function logout() {
        if (currentUserEmail) removeUserSession(currentUserEmail);
        clearTimeout(inactivityTimer); clearTimeout(warningTimer); 
        if (countdownInterval) clearInterval(countdownInterval);
        hideInactivityWarning(); stopGhanaTimeUpdates();
        detachActivityListeners();
        document.getElementById('confirmationDialog').style.display = 'none'; 
        document.getElementById('loginGreeting').style.display = 'none';
        
        // Hide containers
        document.getElementById('dashboardContainer').style.display = 'none';
        document.getElementById('formContainer').style.display = 'none';
        
        // Do NOT clear iframe src ‚Äì keep it preloaded for next login
        // Just hide it
        const ifr = document.getElementById('formIframe');
        if (ifr) ifr.style.visibility = 'hidden';
        
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('email').value = ''; document.getElementById('password').value = ''; 
        document.getElementById('email').focus();
        currentUserName = ''; currentUserEmail = ''; failedAttempts = 0; 
        
        showLogoutNotification();
      }
      
      function showLogoutNotification() {
        const n = document.getElementById('logoutNotification'), c = document.getElementById('logoutCountdown');
        n.style.display = 'flex'; 
        let count = 5; 
        c.textContent = count;
        const i = setInterval(() => { 
          count--; 
          c.textContent = count; 
          if (count <= 0) { 
            clearInterval(i); 
            n.style.display = 'none'; 
            document.getElementById('loginContainer').style.display = 'flex';
          } 
        }, 1000);
      }
      
      // ---------- SESSION CHECK ----------
      function checkExistingSession() {
        const userSession = JSON.parse(localStorage.getItem(USER_SESSION_KEY) || '{}');
        if (userSession.email && userSession.name && userSession.sessionId && Date.now() < userSession.expiry) {
          const sessions = getActiveSessions();
          const activeSession = sessions[userSession.email];
          if (activeSession && activeSession.sessionId === userSession.sessionId) {
            currentUserEmail = userSession.email; currentUserName = userSession.name; setCurrentSessionId(userSession.sessionId);
            // Don't show dashboard yet ‚Äì wait for app loader to finish
            return true;
          }
        }
        if (userSession.email) removeUserSession(userSession.email);
        return false;
      }
      
      // ---------- INIT ‚Äì FULL LOAD THEN DASHBOARD (if session) OR LOGIN ----------
      document.addEventListener('DOMContentLoaded', function() {
        updateAllCopyrightYears();
        
        // Pre-hide iframe visibility
        document.getElementById('formIframe').style.visibility = 'hidden';
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // Simulate full app load ‚Äì wait 1.5 seconds to ensure everything is ready
        setTimeout(function() {
          // Fade out app loader
          const loader = document.getElementById('appLoader');
          loader.style.opacity = '0';
          setTimeout(function() {
            loader.style.display = 'none';
            
            // Now decide: existing session or login
            if (checkExistingSession()) {
              showDashboard();
            } else {
              document.getElementById('loginContainer').style.display = 'flex';
              document.getElementById('email').focus();
              if (!getCurrentSessionId()) setCurrentSessionId(generateSessionId());
            }
          }, 500);
        }, 1500); // Ensures full load before dashboard appears
      });
      
      // ---------- EVENT LISTENERS ----------
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value, pass = document.getElementById('password').value;
        document.getElementById('errorMessage').style.display = 'none'; document.getElementById('attemptsWarning').style.display = 'none';
        if (validateLogin(email, pass)) {
          if (isUserAlreadyLoggedIn(email)) showCustomAlert('Multiple Login Detected', 'This account is already logged in on another device.', 'warning');
          failedAttempts = 0; 
          showDashboard();
        } else handleFailedLogin();
      });
      
      // Dashboard actions ‚Äì REORDERED: View Assignment first, then Make Submission, then Review Materials
      document.getElementById('viewAssignmentCard').addEventListener('click', openViewAssignment);
      document.getElementById('makeSubmissionCard').addEventListener('click', openSubmissionForm);
      document.getElementById('reviewMaterialsCard').addEventListener('click', openReviewMaterials);
      
      document.getElementById('backToDashboardBtn').addEventListener('click', backToDashboard);
      
      // Logout triggers ‚Äì only dashboard logout button now (footer item removed)
      document.getElementById('dashboardLogoutBtn').addEventListener('click', function() { 
        document.getElementById('confirmationDialog').style.display = 'flex'; 
      });
      
      document.getElementById('confirmLogout').addEventListener('click', logout);
      document.getElementById('cancelLogout').addEventListener('click', function() { 
        document.getElementById('confirmationDialog').style.display = 'none'; 
      });
      document.getElementById('keepActiveButton').addEventListener('click', resetActivityTimers);
      document.getElementById('confirmationDialog').addEventListener('click', function(e) { 
        if (e.target === this) this.style.display = 'none'; 
      });
      
      // Session cross-check
      setInterval(function() {
        if (currentUserEmail) {
          const userSession = JSON.parse(localStorage.getItem(USER_SESSION_KEY) || '{}');
          const sessions = getActiveSessions(); const activeSession = sessions[currentUserEmail];
          if (!activeSession || activeSession.sessionId !== userSession.sessionId) { showCustomAlert('Session Ended', 'You logged in from another device.', 'info'); logout(); }
        }
      }, 30000);
      
      // Clean old greeting records
      function cleanOldGreetingRecords() {
        const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}');
        const oneWeek = Date.now() - 7*24*60*60*1000;
        Object.keys(g).forEach(sid => { const ts = parseInt(sid.split('_')[1]); if (ts && ts < oneWeek) delete g[sid]; });
        localStorage.setItem(SHOWN_GREETING_KEY, JSON.stringify(g));
      }
      setInterval(cleanOldGreetingRecords, 24*60*60*1000); cleanOldGreetingRecords();
      
      setInterval(updateAllCopyrightYears, 24*60*60*1000);
    </script>
  </body>
</html>
