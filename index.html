<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>African Emerging Scholars Research Network (AESRN) | Member  Portal Login</title>
    <link rel="icon" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png" type="image/png">
    <link itemprop="image" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">
    <meta property="og:logo" content="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">
    <meta name="twitter:logo" content="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">

    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/aesrn30/aesrn/main/site.webmanifest">
    <script async src="https://tally.so/widgets/embed.js"></script>
    <style type="text/css">
      /* ---------- RESET & BASE ---------- */
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      html, body { 
        height: 100%; 
        width: 100%;
        overflow-x: hidden;
      }
      
      body { 
        display: flex; 
        flex-direction: column; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        color: #1e1e1e;
        -webkit-font-smoothing: antialiased;
      }
      
      /* ---------- LOGIN CONTAINER - BLUE GRADIENT BACKGROUND (ONLY LOGIN) ---------- */
      .login-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px;
        background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        width: 100%;
        min-height: 100vh;
      }
      
      /* MINIMAL LOGIN CARD - WHITE CARD ON BLUE BACKGROUND */
      .login-box {
        background: white;
        border-radius: 8px;
        padding: 40px 32px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 0;
        transition: none;
      }
      
      .login-box:hover {
        transform: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      
      /* ---------- HEADER WITH CENTERED LOGO - ENLARGED ---------- */
      .login-header {
        text-align: center;
        margin-bottom: 32px;
      }
      
      .login-logo-circle {
        width: 100px;
        height: 100px;
        margin: 0 auto 20px auto;
        border-radius: 0;
        background: transparent;
        border: none;
        box-shadow: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .logo-circle-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }
      
      .login-title {
        font-size: 24px;
        font-weight: 600;
        color: #000;
        margin-bottom: 8px;
        letter-spacing: -0.3px;
        line-height: 1.2;
        text-align: center;
      }
      
      .login-subtitle {
        color: #5e5e5e;
        font-size: 14px;
        line-height: 1.5;
        margin: 0;
        max-width: 100%;
        font-weight: 400;
        text-align: center;
      }
      
      /* ---------- FORM ELEMENTS ‚Äì MINIMAL ---------- */
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 6px;
        color: #1e1e1e;
        font-weight: 500;
        font-size: 14px;
        letter-spacing: normal;
      }
      
      .form-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d1d1;
        border-radius: 4px;
        font-size: 15px;
        transition: border-color 0.1s ease;
        background: #ffffff;
        color: #1e1e1e;
        font-weight: 400;
        box-shadow: none;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #1a237e;
        box-shadow: none;
        background: white;
      }
      
      .form-input::placeholder {
        color: #a0a0a0;
        font-weight: 300;
        font-size: 14px;
      }
      
      /* ---------- LOGIN BUTTON ‚Äì FLAT, SOLID ---------- */
      .login-button {
        width: 100%;
        padding: 14px 18px;
        background: #1a237e;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.1s ease;
        margin-top: 12px;
        letter-spacing: 0.3px;
        text-transform: none;
        position: relative;
        overflow: hidden;
        box-shadow: none;
      }
      
      .login-button:hover {
        background: #0f1555;
        transform: none;
        box-shadow: none;
      }
      
      .login-button:active {
        background: #0a1040;
        transform: none;
      }
      
      .login-button::after {
        display: none;
      }
      
      /* ---------- COPYRIGHT ‚Äì FULL TEXT, AUTO-UPDATING YEAR ---------- */
      .copyright-full {
        text-align: center;
        margin-top: 32px;
        font-size: 12px;
        color: #666;
        font-weight: 400;
        border-top: 1px solid #eee;
        padding-top: 20px;
      }
      
      /* ---------- ERROR & WARNING ‚Äì MINIMAL ---------- */
      .error-message {
        color: #d32f2f;
        font-size: 13px;
        margin-top: 16px;
        text-align: center;
        display: none;
        padding: 12px;
        background: #ffebee;
        border-radius: 4px;
        border-left: none;
        font-weight: 500;
      }
      
      .attempts-warning {
        color: #b85a00;
        font-size: 13px;
        margin-top: 12px;
        text-align: center;
        display: none;
        padding: 10px;
        background: #fff1e0;
        border-radius: 4px;
        border-left: none;
        font-weight: 500;
      }
      
      /* ---------- FORM CONTAINER - DEFAULT WHITE BACKGROUND (NOT BLUE) ---------- */
      .form-container {
        flex: 1;
        position: relative;
        display: none;
        width: 100%;
        min-height: calc(100vh - 80px);
        background: white;  /* Default white background for the form area */
      }
      
      iframe { 
        position: absolute; 
        top: 0; 
        right: 0; 
        bottom: 0; 
        left: 0; 
        border: 0; 
        background: white;  /* Ensure iframe background is white */
      }
      
      /* ---------- FOOTER - DARK THEME (PRESERVED) ---------- */
      .footer {
        background: #2c3e50;
        padding: 15px 30px;
        color: #ecf0f1;
        font-size: 14px;
        z-index: 10;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        min-height: 80px;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      
      .footer-left, .footer-right {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }
      
      .user-name { color: #3498db; font-weight: 600; }
      .logout-button {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 18px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }
      .logout-button:hover { background: #c0392b; }
      
      .footer-email {
        color: #3498db;
        text-decoration: none;
      }
      
      .ghana-time-container {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.1);
        padding: 8px 15px;
        border-radius: 4px;
      }
      
      .ghana-time-display {
        font-family: monospace;
        font-size: 14px;
        font-weight: 700;
        color: #2ecc71;
        background: rgba(0,0,0,0.2);
        padding: 4px 10px;
        border-radius: 4px;
        min-width: 85px;
        text-align: center;
      }
      
      /* ---------- NOTIFICATIONS (UNCHANGED) ---------- */
      .login-greeting-notification {
        position: fixed; top: 20px; right: 20px;
        background: #1a237e; color: white;
        padding: 20px 30px; border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        z-index: 2000; display: none; align-items: center; gap: 15px;
        animation: slideInRight 0.5s ease;
        max-width: 350px;
      }
      
      .logout-notification {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #2c3e50; color: white; padding: 30px 40px; border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 3000; display: none;
        flex-direction: column; align-items: center; gap: 20px; min-width: 300px;
        text-align: center;
      }
      
      .inactivity-warning {
        display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #2c3e50; color: white; border-radius: 12px; padding: 30px;
        width: 90%; max-width: 400px; z-index: 4000; text-align: center;
      }
      
      .confirmation-overlay {
        display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
      }
      
      .confirmation-dialog {
        background: white; border-radius: 12px; padding: 40px; width: 90%; max-width: 400px;
        text-align: center;
      }
      
      /* ---------- MOBILE ELEMENTS (UNCHANGED) ---------- */
      .mobile-logout-button {
        position: fixed; top: 15px; right: 15px;
        background: #e74c3c; color: white; border: none; border-radius: 50px;
        padding: 12px 20px; font-size: 13px; font-weight: 600; cursor: pointer;
        z-index: 1000; display: none; box-shadow: 0 4px 15px rgba(231,76,60,0.3);
      }
      
      .mobile-header-info {
        position: fixed; top: 15px; left: 15px;
        background: #1a237e; color: white; border-radius: 50px;
        padding: 10px 18px; font-size: 13px; font-weight: 600; z-index: 1000; display: none;
      }
      
      .mobile-top-button {
        position: fixed; bottom: 20px; right: 20px;
        background: #1a237e; color: white; border: none; border-radius: 50%;
        width: 50px; height: 50px; font-size: 22px; cursor: pointer; z-index: 1000;
        display: none; justify-content: center; align-items: center;
      }
      
      @media (max-width: 768px) {
        .login-box { padding: 32px 24px; }
        .login-logo-circle { width: 90px; height: 90px; }
        .mobile-logout-button, .mobile-header-info, .mobile-top-button { display: block; }
        .footer { display: none !important; }
        .form-container { min-height: 100vh; }
      }
      
      @media (max-width: 480px) {
        .login-box { padding: 24px 20px; }
        .login-title { font-size: 22px; }
        .login-logo-circle { width: 80px; height: 80px; }
      }
      
      /* ---------- LOADING OVERLAY ---------- */
      .loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.95); display: flex; flex-direction: column;
        justify-content: center; align-items: center; z-index: 100;
      }
      
      .loading-spinner {
        width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #1a237e;
        border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
      }
      
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      @keyframes slideInRight { from { transform: translateX(100%) translateY(-20px); opacity: 0; } to { transform: translateX(0) translateY(0); opacity: 1; } }
    </style>
  </head>
  <body>
      <!-- LOGIN CONTAINER ‚Äì BLUE GRADIENT BACKGROUND (ONLY LOGIN INTERFACE) -->
    <div class="login-container" id="loginContainer">
      <div class="login-box">
        <div class="login-header">
          <div class="login-logo-circle">
            <img src="https://raw.githubusercontent.com/aesrn30/aesrn/main/Lablogo.png" 
                 alt="AESRN Logo" 
                 class="logo-circle-image">
          </div>
          
          <div class="login-title">Member Access Portal</div>
          <div class="login-subtitle">
            Enter your credentials to access the submission form.
          </div>
        </div>
        
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input 
              type="email" 
              id="email" 
              class="form-input" 
              placeholder="Enter registered email address"
              required
              autocomplete="off"
            >
          </div>
          
          <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <input 
              type="password" 
              id="password" 
              class="form-input" 
              placeholder="Enter access password"
              required
              autocomplete="off"
            >
          </div>
          
          <button type="submit" class="login-button" id="loginButton">Log In</button>
          
          <!-- FULL COPYRIGHT WITH AUTO-UPDATING YEAR -->
          <div class="copyright-full" id="copyrightFull">
            Copyright ¬© <span id="dynamicYear"></span> AESRN. All rights reserved.
          </div>
          
          <div class="error-message" id="errorMessage">
            Invalid email or password.
          </div>
          
          <div class="attempts-warning" id="attemptsWarning">
            Multiple failed attempts may temporarily restrict access.
          </div>
        </form>
      </div>
    </div>
    
    <!-- FORM CONTAINER - DEFAULT WHITE BACKGROUND (NOT BLUE) -->
    <div class="form-container" id="formContainer">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading form...</div>
      </div>
      
      <div class="mobile-header-info" id="mobileHeaderInfo">
        <span id="mobileUserName"></span>
      </div>
      <button class="mobile-logout-button" id="mobileLogoutButton">
        <span class="mobile-user-name" id="mobileUserNameShort"></span> Logout
      </button>
      <button class="mobile-top-button" id="mobileTopButton">‚Üë</button>
      
      <iframe 
        data-tally-src="https://tally.so/r/dWd6gA?transparentBackground=1&formEventsForwarding=1" 
        width="100%" 
        height="100%" 
        frameborder="0" 
        marginheight="0" 
        marginwidth="0" 
        title="African Emerging Scholars Research Network (AESRN)"
        id="formIframe"
        style="visibility: hidden; background: white;"
        onload="hideLoading()"
      ></iframe>
    </div>
    
    <!-- FOOTER (unchanged) -->
    <footer class="footer" style="display: none;" id="siteFooter">
      <div class="footer-left">
        <div>Logged in as: <span class="user-name" id="userNameDisplay"></span></div>
        <button class="logout-button" id="logoutButton">Logout</button>
      </div>
      <div class="footer-right">
        <div><a href="mailto:research.aesrn@yahoo.com" class="footer-email">research.aesrn@yahoo.com</a></div>
        <div class="ghana-time-container">
          <span class="ghana-flag">üá¨üá≠</span>
          <span class="ghana-time-display" id="ghanaTimeDisplay">--:--:--</span>
          <span class="ghana-timezone">GMT</span>
        </div>
      </div>
      <div class="footer-copyright">
        Copyright ¬© <span id="copyrightYear"></span> AESRN. All rights reserved.
      </div>
    </footer>
    
    <!-- NOTIFICATIONS / MODALS (all unchanged) -->
    <div class="login-greeting-notification" id="loginGreeting">
      <div class="greeting-icon" id="greetingIcon">üëã</div>
      <div class="greeting-content">
        <h4 id="greetingText">Welcome</h4>
        <p id="userGreeting"></p>
      </div>
    </div>
    
    <div class="logout-notification" id="logoutNotification">
      <div class="logout-spinner"></div>
      <div class="logout-message">Logged out successfully!</div>
      <div class="logout-countdown">Redirecting in <span id="logoutCountdown">5</span> seconds...</div>
    </div>
    
    <div class="inactivity-warning" id="inactivityWarning">
      <h3>Session Timeout</h3>
      <div class="inactivity-timer" id="inactivityTimer">2:00</div>
      <p class="inactivity-message">You've been inactive. Click to stay logged in.</p>
      <button class="keep-active-button" id="keepActiveButton">Keep Me Logged In</button>
    </div>
    
    <div class="confirmation-overlay" id="confirmationDialog">
      <div class="confirmation-dialog">
        <div class="confirmation-icon">‚ö†Ô∏è</div>
        <div class="confirmation-title">Confirm Logout</div>
        <div class="confirmation-message">Are you sure you want to log out?</div>
        <div class="confirmation-buttons">
          <button class="confirm-button confirm-yes" id="confirmLogout">Yes, Logout</button>
          <button class="confirm-button confirm-no" id="cancelLogout">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      // ---------- AUTO-UPDATE COPYRIGHT YEAR FUNCTION ----------
      function updateAllCopyrightYears() {
        const currentYear = new Date().getFullYear();
        
        // Update the dynamic year in the login card copyright
        const dynamicYearElement = document.getElementById('dynamicYear');
        if (dynamicYearElement) {
          dynamicYearElement.textContent = currentYear;
        }
        
        // Update the footer copyright year
        const copyrightYearElement = document.getElementById('copyrightYear');
        if (copyrightYearElement) {
          copyrightYearElement.textContent = currentYear;
        }
      }

      // ---------- USER CREDENTIALS (unchanged) ----------
      const userMap = {
        "malikseidu4@gmail.com": "Abdul-Malik",
        "Malikseidu4@gmail.com": "Abdul-Malik",
        "abdul0247080685@gmail.com": "Abdul Latif",
        "Abdul0247080685@gmail.com": "Abdul Latif",
        "ednadie93@gmail.com": "Edna",
        "Ednadie93@gmail.com": "Edna",
        "issahaqalhassan26@gmail.com": "Alhassan",
        "Issahaqalhassan26@gmail.com": "Alhassan",
        "mudassiribrahim30@gmail.com": "Mudasir",
        "Mudassiribrahim30@gmail.com": "Mudasir"
      };
      
      const correctPassword = "Scholar123";
      
      // ---------- GLOBAL VARIABLES (unchanged) ----------
      let failedAttempts = 0;
      const maxAttempts = 5;
      let currentUserName = "";
      let currentUserEmail = "";
      
      let ghanaTimeInterval;
      
      const SESSION_TIMEOUT = 2 * 60 * 1000;
      const WARNING_TIME = 1 * 60 * 1000;
      let inactivityTimer, warningTimer;
      
      const ACTIVE_SESSIONS_KEY = 'aesrn_active_sessions';
      const CURRENT_SESSION_KEY = 'aesrn_current_session';
      const USER_SESSION_KEY = 'aesrn_user_session';
      const SHOWN_GREETING_KEY = 'aesrn_shown_greeting';
      
      // ---------- SESSION FUNCTIONS (fully preserved) ----------
      function generateSessionId() { return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); }
      function getCurrentSessionId() { return sessionStorage.getItem(CURRENT_SESSION_KEY); }
      function setCurrentSessionId(sessionId) { sessionStorage.setItem(CURRENT_SESSION_KEY, sessionId); }
      function getActiveSessions() { const s = localStorage.getItem(ACTIVE_SESSIONS_KEY); return s ? JSON.parse(s) : {}; }
      function saveActiveSessions(sessions) { localStorage.setItem(ACTIVE_SESSIONS_KEY, JSON.stringify(sessions)); }
      function hasGreetingBeenShown(sessionId) { const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}'); return g[sessionId] || false; }
      function markGreetingAsShown(sessionId) { const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}'); g[sessionId] = true; localStorage.setItem(SHOWN_GREETING_KEY, JSON.stringify(g)); }
      function clearGreetingStatus(sessionId) { const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}'); delete g[sessionId]; localStorage.setItem(SHOWN_GREETING_KEY, JSON.stringify(g)); }
      
      function isUserAlreadyLoggedIn(email) {
        const sessions = getActiveSessions();
        const userSession = sessions[email];
        if (!userSession) return false;
        if (Date.now() > userSession.expiry) { delete sessions[email]; saveActiveSessions(sessions); return false; }
        const currentSessionId = getCurrentSessionId();
        return !(userSession.sessionId === currentSessionId);
      }
      
      function registerUserSession(email, name) {
        const sessionId = generateSessionId();
        const sessions = getActiveSessions();
        if (sessions[email]) { clearGreetingStatus(sessions[email].sessionId); delete sessions[email]; }
        sessions[email] = { sessionId, expiry: Date.now() + SESSION_TIMEOUT, name, loginTime: Date.now(), isFirstLogin: true };
        saveActiveSessions(sessions);
        setCurrentSessionId(sessionId);
        const userSession = { email, name, sessionId, loginTime: Date.now(), expiry: Date.now() + SESSION_TIMEOUT, isFirstLogin: true };
        localStorage.setItem(USER_SESSION_KEY, JSON.stringify(userSession));
        return sessionId;
      }
      
      function updateSessionExpiry() {
        const sessions = getActiveSessions();
        const userSession = JSON.parse(localStorage.getItem(USER_SESSION_KEY) || '{}');
        if (userSession.email && sessions[userSession.email]) {
          sessions[userSession.email].expiry = Date.now() + SESSION_TIMEOUT;
          saveActiveSessions(sessions);
          userSession.expiry = Date.now() + SESSION_TIMEOUT;
          localStorage.setItem(USER_SESSION_KEY, JSON.stringify(userSession));
        }
      }
      
      function removeUserSession(email) {
        const sessions = getActiveSessions();
        if (sessions[email]) { clearGreetingStatus(sessions[email].sessionId); delete sessions[email]; saveActiveSessions(sessions); }
        localStorage.removeItem(USER_SESSION_KEY);
        sessionStorage.removeItem(CURRENT_SESSION_KEY);
      }
      
      function getGreeting() { const h = new Date().getHours(); if (h<12) return "Good Morning"; if (h<17) return "Good Afternoon"; return "Good Evening"; }
      function getGreetingIcon() { const h = new Date().getHours(); if (h<12) return "üåÖ"; if (h<17) return "‚òÄÔ∏è"; return "üåô"; }
      
      function showLoginGreeting() {
        const sessionId = getCurrentSessionId();
        if (hasGreetingBeenShown(sessionId)) return;
        document.getElementById('greetingText').textContent = getGreeting();
        document.getElementById('greetingIcon').textContent = getGreetingIcon();
        document.getElementById('userGreeting').textContent = `${getGreeting()}, ${currentUserName}!`;
        document.getElementById('loginGreeting').style.display = 'flex';
        markGreetingAsShown(sessionId);
        setTimeout(() => { 
          document.getElementById('loginGreeting').style.animation = 'fadeOutUp 0.5s ease';
          setTimeout(() => { 
            document.getElementById('loginGreeting').style.display = 'none'; 
            document.getElementById('loginGreeting').style.animation = 'slideInRight 0.5s ease';
          }, 500);
        }, 5000);
      }
      
      function hideLoading() { 
        const lo = document.getElementById('loadingOverlay'), ifr = document.getElementById('formIframe');
        if (lo) { lo.style.opacity = '0'; setTimeout(() => { lo.style.display = 'none'; if (ifr) ifr.style.visibility = 'visible'; }, 300); }
      }
      function showLoading() { 
        const lo = document.getElementById('loadingOverlay'), ifr = document.getElementById('formIframe');
        if (lo) { lo.style.display = 'flex'; lo.style.opacity = '1'; } if (ifr) ifr.style.visibility = 'hidden';
      }
      
      function getGhanaTime() { 
        const g = new Date(new Date().toLocaleString('en-US', { timeZone: 'Africa/Accra' }));
        return `${g.getHours().toString().padStart(2,'0')}:${g.getMinutes().toString().padStart(2,'0')}:${g.getSeconds().toString().padStart(2,'0')}`;
      }
      function updateGhanaTime() { const el = document.getElementById('ghanaTimeDisplay'); if (el) el.textContent = getGhanaTime(); }
      function startGhanaTimeUpdates() { updateGhanaTime(); ghanaTimeInterval = setInterval(updateGhanaTime, 1000); }
      function stopGhanaTimeUpdates() { clearInterval(ghanaTimeInterval); }
      
      function validateLogin(email, password) {
        const normEmail = email.trim(), normPass = password.trim();
        const key = Object.keys(userMap).find(k => k.toLowerCase() === normEmail.toLowerCase());
        if (key) { currentUserName = userMap[key]; currentUserEmail = key; return normPass === correctPassword; }
        return false;
      }
      
      function handleFailedLogin() {
        failedAttempts++;
        const err = document.getElementById('errorMessage'), warn = document.getElementById('attemptsWarning');
        const email = document.getElementById('email'), pwd = document.getElementById('password'), btn = document.getElementById('loginButton');
        err.style.display = 'block'; email.classList.add('error'); pwd.classList.add('error'); pwd.value = ''; email.focus();
        if (failedAttempts >= 3) warn.style.display = 'block';
        if (failedAttempts >= maxAttempts) {
          btn.disabled = true; btn.textContent = 'Access Temporarily Restricted';
          setTimeout(() => { btn.disabled = false; btn.textContent = 'Log In'; warn.style.display = 'none'; failedAttempts = 0; }, 30000);
        }
        setTimeout(() => { email.classList.remove('error'); pwd.classList.remove('error'); }, 2000);
      }
      
      function loadTallyForm() { const ifr = document.getElementById('formIframe'); if (ifr && ifr.dataset.tallySrc) { ifr.src = ifr.dataset.tallySrc; showLoading(); } else setTimeout(hideLoading, 3000); }
      
      function resetActivityTimers() {
        lastActivityTime = Date.now();
        clearTimeout(inactivityTimer); clearTimeout(warningTimer); hideInactivityWarning();
        updateSessionExpiry();
        warningTimer = setTimeout(showInactivityWarning, WARNING_TIME);
        inactivityTimer = setTimeout(logoutDueToInactivity, SESSION_TIMEOUT);
      }
      function showInactivityWarning() { document.getElementById('inactivityWarning').style.display = 'block'; startInactivityCountdown(120); }
      function hideInactivityWarning() { document.getElementById('inactivityWarning').style.display = 'none'; }
      function startInactivityCountdown(sec) {
        const timer = document.getElementById('inactivityTimer'); let remaining = sec;
        function update() { const m = Math.floor(remaining/60), s = remaining%60; timer.textContent = `${m}:${s<10?'0':''}${s}`; if (remaining<=0) clearInterval(i); else remaining--; }
        update(); const i = setInterval(update, 1000);
      }
      function logoutDueToInactivity() { showCustomAlert('Session Expired', 'Your session has expired due to inactivity.', 'info'); logout(); }
      
      function showCustomAlert(title, message, type = 'info') {
        const icon = type==='info' ? '‚ÑπÔ∏è' : type==='warning' ? '‚ö†Ô∏è' : '‚ùå';
        const overlay = document.getElementById('confirmationDialog');
        overlay.innerHTML = `<div class="confirmation-dialog"><div class="confirmation-icon">${icon}</div><div class="confirmation-title">${title}</div><div class="confirmation-message">${message}</div><div class="confirmation-buttons"><button class="confirm-button confirm-no" id="closeAlert">OK</button></div></div>`;
        overlay.style.display = 'flex';
        document.getElementById('closeAlert').addEventListener('click', function() { overlay.style.display = 'none'; });
      }
      
      function trackUserActivity() { resetActivityTimers(); }
      
      function checkExistingSession() {
        const userSession = JSON.parse(localStorage.getItem(USER_SESSION_KEY) || '{}');
        if (userSession.email && userSession.name && userSession.sessionId && Date.now() < userSession.expiry) {
          const sessions = getActiveSessions();
          const activeSession = sessions[userSession.email];
          if (activeSession && activeSession.sessionId === userSession.sessionId) {
            currentUserEmail = userSession.email; currentUserName = userSession.name; setCurrentSessionId(userSession.sessionId);
            loadFormAfterLogin(false); return true;
          }
        }
        if (userSession.email) removeUserSession(userSession.email);
        return false;
      }
      
      function updateMobileUI() {
        const m1 = document.getElementById('mobileUserName'), m2 = document.getElementById('mobileUserNameShort');
        if (currentUserName) { m1.textContent = `Logged in as: ${currentUserName}`; m2.textContent = currentUserName.length > 10 ? currentUserName.substring(0,10)+'...' : currentUserName; }
      }
      
      function loadFormAfterLogin(showGreeting = true) {
        document.getElementById('userNameDisplay').textContent = currentUserName;
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('formContainer').style.display = 'flex';
        updateMobileUI();
        if (window.innerWidth > 768) document.getElementById('siteFooter').style.display = 'flex'; else document.getElementById('siteFooter').style.display = 'none';
        startGhanaTimeUpdates(); loadTallyForm();
        const sessionId = registerUserSession(currentUserEmail, currentUserName);
        if (showGreeting) showLoginGreeting();
        resetActivityTimers();
        document.addEventListener('mousemove', trackUserActivity); document.addEventListener('keydown', trackUserActivity);
        document.addEventListener('click', trackUserActivity); document.addEventListener('scroll', trackUserActivity);
      }
      
      function showLogoutNotification() {
        const n = document.getElementById('logoutNotification'), c = document.getElementById('logoutCountdown');
        n.style.display = 'flex'; let count = 5; c.textContent = count;
        const i = setInterval(() => { count--; c.textContent = count; if (count<=0) { clearInterval(i); n.style.display = 'none'; document.getElementById('loginContainer').style.display = 'flex'; document.getElementById('formContainer').style.display = 'none'; document.getElementById('siteFooter').style.display = 'none'; } }, 1000);
      }
      
      function logout() {
        if (currentUserEmail) removeUserSession(currentUserEmail);
        clearTimeout(inactivityTimer); clearTimeout(warningTimer); hideInactivityWarning(); stopGhanaTimeUpdates();
        document.removeEventListener('mousemove', trackUserActivity); document.removeEventListener('keydown', trackUserActivity);
        document.removeEventListener('click', trackUserActivity); document.removeEventListener('scroll', trackUserActivity);
        document.getElementById('confirmationDialog').style.display = 'none'; document.getElementById('loginGreeting').style.display = 'none';
        const ifr = document.getElementById('formIframe'); if (ifr) { ifr.src = ''; ifr.style.visibility = 'hidden'; }
        const lo = document.getElementById('loadingOverlay'); if (lo) { lo.style.display = 'flex'; lo.style.opacity = '1'; }
        document.getElementById('email').value = ''; document.getElementById('password').value = ''; document.getElementById('email').focus();
        currentUserName = ''; currentUserEmail = ''; failedAttempts = 0; updateMobileUI(); showLogoutNotification();
      }
      
      function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
      
      // ---------- INITIALIZATION ----------
      document.addEventListener('DOMContentLoaded', function() {
        // Update all copyright years automatically
        updateAllCopyrightYears();
        
        if (checkExistingSession()) { console.log('Existing session found, auto-login (no greeting)'); return; }
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('siteFooter').style.display = 'none';
        document.getElementById('email').focus();
        if (!getCurrentSessionId()) setCurrentSessionId(generateSessionId());
      });
      
      // ---------- EVENT LISTENERS ----------
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value, pass = document.getElementById('password').value;
        document.getElementById('errorMessage').style.display = 'none'; document.getElementById('attemptsWarning').style.display = 'none';
        if (validateLogin(email, pass)) {
          if (isUserAlreadyLoggedIn(email)) showCustomAlert('Multiple Login Detected', 'This account is already logged in on another device. The other session will be logged out.', 'warning');
          failedAttempts = 0; loadFormAfterLogin(true);
        } else handleFailedLogin();
      });
      
      document.getElementById('logoutButton').addEventListener('click', function() { document.getElementById('confirmationDialog').style.display = 'flex'; });
      document.getElementById('mobileLogoutButton').addEventListener('click', function() { document.getElementById('confirmationDialog').style.display = 'flex'; });
      document.getElementById('mobileTopButton').addEventListener('click', scrollToTop);
      document.getElementById('confirmLogout').addEventListener('click', logout);
      document.getElementById('cancelLogout').addEventListener('click', function() { document.getElementById('confirmationDialog').style.display = 'none'; });
      document.getElementById('keepActiveButton').addEventListener('click', resetActivityTimers);
      document.getElementById('confirmationDialog').addEventListener('click', function(e) { if (e.target === this) this.style.display = 'none'; });
      document.getElementById('email').addEventListener('focus', function() { this.classList.remove('error'); });
      document.getElementById('password').addEventListener('focus', function() { this.classList.remove('error'); });
      document.getElementById('password').addEventListener('keypress', function(e) { if (e.key === 'Enter') document.getElementById('loginForm').dispatchEvent(new Event('submit')); });
      
      window.addEventListener('resize', function() {
        if (currentUserName) document.getElementById('siteFooter').style.display = window.innerWidth > 768 ? 'flex' : 'none';
      });
      
      setInterval(function() {
        if (currentUserEmail) {
          const userSession = JSON.parse(localStorage.getItem(USER_SESSION_KEY) || '{}');
          const sessions = getActiveSessions(); const activeSession = sessions[currentUserEmail];
          if (!activeSession || activeSession.sessionId !== userSession.sessionId) { showCustomAlert('Session Ended', 'You logged in from another device.', 'info'); logout(); }
        }
      }, 30000);
      
      function cleanOldGreetingRecords() {
        const g = JSON.parse(localStorage.getItem(SHOWN_GREETING_KEY) || '{}');
        const oneWeek = Date.now() - 7*24*60*60*1000;
        Object.keys(g).forEach(sid => { const ts = parseInt(sid.split('_')[1]); if (ts && ts < oneWeek) delete g[sid]; });
        localStorage.setItem(SHOWN_GREETING_KEY, JSON.stringify(g));
      }
      setInterval(cleanOldGreetingRecords, 24*60*60*1000); cleanOldGreetingRecords();
      
      window.addEventListener('scroll', function() {
        const btn = document.getElementById('mobileTopButton');
        btn.style.display = window.scrollY > 300 ? 'flex' : 'none';
      });
      
      // Re-run copyright update every day to ensure year is always current
      setInterval(updateAllCopyrightYears, 24 * 60 * 60 * 1000);
    </script>
  </body>
</html>
